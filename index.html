<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Launcher dinamico (bundle.js)</title>
<style>
   html, body { height: 100%; margin: 0; }
   body { font-family: Arial, sans-serif; overflow: hidden; }
   /* Launcher */
   #launcher {
     height: 100vh;
     display: flex;
     align-items: center;
     justify-content: center;
     padding: 24px;
     box-sizing: border-box;
   }
   #panel {
     width: min(900px, 95vw);
     border: 1px solid #ddd;
     border-radius: 10px;
     padding: 18px;
     box-shadow: 0 10px 30px rgba(0,0,0,.08);
     background: #fff;
   }
   #panel h2 { margin: 0 0 12px; }
   .row {
     display: grid;
     grid-template-columns: 180px 1fr;
     gap: 10px;
     align-items: center;
     margin: 10px 0;
   }
   input, textarea {
     width: 100%;
     font-size: 14px;
     padding: 8px 10px;
     box-sizing: border-box;
   }
   textarea { height: 70px; resize: vertical; }
   .btns {
     display: flex;
     gap: 10px;
     margin-top: 12px;
   }
   button {
     padding: 10px 14px;
     font-size: 14px;
     cursor: pointer;
   }
   .hint {
     margin-top: 10px;
     font-size: 12px;
     color: #555;
     line-height: 1.4;
   }
   /* Fullscreen host (iframe) */
   #host {
     height: 100vh;
     display: none;
   }
   /* wrapper del bundle */
   #host .sfdc-component,
   #host .scroll-wrapper {
     height: 100vh !important;
     overflow: hidden !important;
   }
   /* iframe full screen */
   #host iframe {
     width: 100%;
     height: 100vh !important;
     border: 0;
     display: block;
   }
   /* Close button sopra iframe */
   #close {
     position: fixed;
     top: 10px;
     right: 10px;
     z-index: 99999;
     display: none;
     padding: 8px 10px;
     border-radius: 8px;
     border: 1px solid #ccc;
     background: #fff;
   }
</style>
</head>
<body>
<!-- Launcher -->
<div id="launcher">
<div id="panel">
<h2>Launcher dinamico (test bundle.js)</h2>
<div class="row">
<label>Community base</label>
<input id="communityUri" value="https://ppcrmagenti.axa-italia.it/tabs/" />
</div>
<div class="row">
<label>Visualforce</label>
<input id="visualforce" value="javascriptIntegration" />
</div>
<div class="row">
<label>Componente (c:...)</label>
<input id="componentName" value="mobilityLeadListView" />
</div>
<div class="row">
<label>Params (querystring)</label>
<textarea id="paramsText">widget=true&limit=5&DefaultFilter=All</textarea>
</div>
<div class="row">
<label>Breadcrumb</label>
<input id="breadcrumb" value="Homepage" />
</div>
<div class="btns">
<button id="launchBtn">Lancia</button>
</div>
<div class="hint">
<div><b>Params</b>: scrivi tipo <code>key=value&key2=value2</code> (finiscono nella query dell’iframe).</div>
<div><b>Breadcrumb</b>: separa con virgola (es. <code>Homepage,Lista Lead</code>) → diventa <code>breadcrumbLabels=...</code>.</div>
<div><b>Comportamento</b>: fullscreen iframe + gestione postMessage (Homepage chiude, OPEN_QUOT apre nuova tab).</div>
</div>
</div>
</div>
<!-- Fullscreen host -->
<div id="host"></div>
<button id="close">✕ Chiudi</button>
<!-- Bundle -->
<script src="./bundle.js"></script>
<script>
   // ---------- helpers parsing ----------
   function parseQueryString(qs) {
     const out = {};
     const s = (qs || "").trim().replace(/^\?/, "");
     if (!s) return out;
     for (const part of s.split("&")) {
       if (!part) continue;
       const [kRaw, vRaw = ""] = part.split("=");
       const k = decodeURIComponent(kRaw || "").trim();
       const v = decodeURIComponent(vRaw || "").trim();
       if (!k) continue;
       out[k] = v;
     }
     return out;
   }
   function parseBreadcrumb(str) {
     const labels = (str || "")
       .split(",")
       .map(s => s.trim())
       .filter(Boolean);
     return labels.map(label => ({ label }));
   }
   // ---------- fullscreen controls ----------
   function openFullscreen() {
     document.getElementById("launcher").style.display = "none";
     document.getElementById("host").style.display = "block";
     document.getElementById("close").style.display = "block";
     document.body.style.overflow = "hidden";
   }
   function closeFullscreen() {
     document.getElementById("host").style.display = "none";
     document.getElementById("launcher").style.display = "flex";
     document.getElementById("close").style.display = "none";
     document.getElementById("host").innerHTML = "";
   }
   document.getElementById("close").onclick = closeFullscreen;
   // ---------- community URL helpers ----------
   function getCommunitySBase() {
     const tabs = (window.SalesforceAuth?.communityURI || document.getElementById("communityUri")?.value || "").trim();
     if (tabs.includes("/tabs/")) return tabs.replace(/\/tabs\/?$/, "/s/");
     if (tabs.endsWith("/")) return tabs + "s/";
     return tabs + "/s/";
   }
   function openInNewTab(url) {
     window.open(url, "_blank", "noopener,noreferrer");
   }
   function openRecordDetail(recordId) {
     const base = getCommunitySBase();
     openInNewTab(`${base}detail/${encodeURIComponent(recordId)}`);
   }
   // ---------- postMessage handler (child -> parent) ----------
   window.addEventListener("message", (e) => {
     const msg = e.data;
     if (!msg) return;
     if (msg.action) console.log("[FROM IFRAME]", msg);
     // Chiudi su Homepage breadcrumb
     if (msg.action === "NAVIGATETO") {
       const name  = (msg.target?.name  || "").toString().toLowerCase();
       const label = (msg.target?.label || "").toString().toLowerCase();
       if (name === "homepage" || label === "homepage" || label === "home") {
         closeFullscreen();
         return;
       }
     }
     // Apri URL in nuova tab
     if (msg.action === "GOTO" && typeof msg.url === "string") {
       openInNewTab(msg.url);
       return;
     }
     // Chiudi esplicito
     if (msg.action === "CLOSE_MODAL") {
       closeFullscreen();
       return;
     }
     // OPEN_CALLBACK: tutte le tipologie
     if (msg.action === "OPEN_CALLBACK") {
       const p = msg.params || {};
       const type = (p.type || "").toString();
       const recordId = p.recordId;
       switch (type) {
         case "OPEN_QUOT":
         case "OPEN_OPP":
         case "OPEN_TASK":
         case "OPEN_EVENT":
         case "OPEN_CUSTOM":
         case "OPEN_REPORT":
         case "CONVERT_LEAD":
           if (recordId) openRecordDetail(recordId);
           else console.warn("OPEN_CALLBACK senza recordId", p);
           return;
         case "OPEN_SUBJECT": {
           // qui recordId può non essere un Salesforce Id, fallback su ricerca
           const base = getCommunitySBase();
           const value = (recordId || "").toString();
           openInNewTab(`${base}global-search/${encodeURIComponent(value)}`);
           return;
         }
         case "NEW_PROP":
           // qui spesso arriva recordData; log e basta (o implementa una route specifica)
           console.log("[NEW_PROP]", p.recordData || p);
           return;
         default:
           console.warn("[OPEN_CALLBACK] type non gestito:", type, p);
           return;
       }
     }
     // HOOK_REQUEST / AUTH_REFRESH: normalmente solo log/ack (non aprono)
     if (msg.action === "HOOK_REQUEST") {
       try { e.source?.postMessage({ action: "HOOK_RESPONSE", id: msg.id }, "*"); } catch {}
       return;
     }
     if (msg.action === "AUTH_REFRESH") {
       return;
     }
   });
   // ---------- launch button ----------
   document.getElementById("launchBtn").onclick = () => {
     const communityUri = document.getElementById("communityUri").value.trim();
     const visualforce  = (document.getElementById("visualforce").value || "javascriptIntegration").trim();
     const component    = document.getElementById("componentName").value.trim();
     const paramsText   = document.getElementById("paramsText").value;
     const breadcrumbStr= document.getElementById("breadcrumb").value;
     if (!communityUri) return alert("Inserisci la Community base (es. https://.../tabs/).");
     if (!component) return alert("Inserisci il nome componente (es. mobilityLeadListView).");
     // fallback usato dal bundle
     localStorage.setItem("fallback", "true");
     // Application deve essere l’istanza reale del bundle
     window.Application = new window.AxaApplication({}, (authParams) => console.log("[authCallback]", authParams));
     // fallback communityURI usato da Lightning.communityURI
     if (window.SalesforceAuth) window.SalesforceAuth.communityURI = communityUri;
     // prepara params per SalesforceConnect
     const paramsObj = parseQueryString(paramsText);
     paramsObj.auth = true;                  // forza authenticated nel Lightning
     paramsObj.lwc = false;                  // iframe mode
     paramsObj.visualforce = visualforce;    // VF page
     paramsObj.breadcrumb = parseBreadcrumb(breadcrumbStr);
     // fullscreen
     openFullscreen();
     // container
     const host = document.getElementById("host");
     const containerId = component; // id usato anche come iframe id nel Lightning
     host.innerHTML = `<div id="${containerId}"></div>`;
     // mount: crea iframe via bundle
     new window.SalesforceConnect(component, containerId, paramsObj);
     // debug: stampa src iframe
     setTimeout(() => {
       const iframe = document.getElementById(containerId);
       console.log("[iframe src]", iframe?.getAttribute("src"));
     }, 800);
   };
</script>
</body>
</html>
