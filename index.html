<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Test bundle.js - Launcher dinamico</title>
<style>
   html, body { height: 100%; margin: 0; }
   body { font-family: Arial, sans-serif; overflow: hidden; }
   /* Schermata iniziale */
   #launcher {
     height: 100vh;
     display: flex;
     align-items: center;
     justify-content: center;
     padding: 24px;
     box-sizing: border-box;
   }
   #panel {
     width: min(900px, 95vw);
     border: 1px solid #ddd;
     border-radius: 10px;
     padding: 18px;
     box-shadow: 0 10px 30px rgba(0,0,0,.08);
   }
   #panel h2 { margin: 0 0 12px; }
   .row {
     display: grid;
     grid-template-columns: 180px 1fr;
     gap: 10px;
     align-items: center;
     margin: 10px 0;
   }
   input, textarea {
     width: 100%;
     font-size: 14px;
     padding: 8px 10px;
     box-sizing: border-box;
   }
   textarea { height: 70px; resize: vertical; }
   .btns {
     display: flex;
     gap: 10px;
     margin-top: 12px;
   }
   button {
     padding: 10px 14px;
     font-size: 14px;
     cursor: pointer;
   }
   .hint {
     margin-top: 10px;
     font-size: 12px;
     color: #555;
     line-height: 1.4;
   }
   /* Fullscreen iframe */
   #host {
     height: 100vh;
     display: none;
   }
   #host .sfdc-component,
   #host .scroll-wrapper {
     height: 100vh !important;
     overflow: hidden !important;
   }
   #host iframe {
     width: 100%;
     height: 100vh !important;
     border: 0;
     display: block;
   }
   /* Close button */
   #close {
     position: fixed;
     top: 10px;
     right: 10px;
     z-index: 99999;
     display: none;
     padding: 8px 10px;
     border-radius: 8px;
     border: 1px solid #ccc;
     background: #fff;
   }
</style>
</head>
<body>
<!-- Launcher -->
<div id="launcher">
<div id="panel">
<h2>Launcher dinamico (bundle.js)</h2>
<div class="row">
<label>Community base</label>
<input id="communityUri" value="https://ppcrmagenti.axa-italia.it/tabs/" />
</div>
<div class="row">
<label>Visualforce</label>
<input id="visualforce" value="javascriptIntegration" />
</div>
<div class="row">
<label>Componente (c:...)</label>
<input id="componentName" value="mobilityLeadListView" />
</div>
<div class="row">
<label>Params (querystring)</label>
<textarea id="paramsText">widget=true&limit=5&DefaultFilter=All</textarea>
</div>
<div class="row">
<label>Breadcrumb</label>
<input id="breadcrumb" value="Homepage" />
</div>
<div class="btns">
<button id="launchBtn">Lancia</button>
</div>
<div class="hint">
<div><b>Params</b>: scrivi tipo <code>key=value&key2=value2</code>. Verranno aggiunti alla query dell’iframe.</div>
<div><b>Breadcrumb</b>: separa con virgola (es. <code>Homepage,Lista Lead</code>) → diventa <code>breadcrumbLabels=...</code>.</div>
</div>
</div>
</div>
<!-- Fullscreen host -->
<div id="host"></div>
<button id="close">✕ Chiudi</button>
<!-- Bundle -->
<script src="./bundle.js"></script>
<script>
   // Log messaggi dall’iframe (HOOK_REQUEST / AUTH_REFRESH ecc.)
   window.addEventListener("message", (e) => {
     if (e.data?.action) console.log("[FROM IFRAME]", e.data);
   });
   function parseQueryString(qs) {
     // Accetta "a=1&b=2" -> {a:"1", b:"2"}
     const out = {};
     const s = (qs || "").trim().replace(/^\?/, "");
     if (!s) return out;
     for (const part of s.split("&")) {
       if (!part) continue;
       const [kRaw, vRaw = ""] = part.split("=");
       const k = decodeURIComponent(kRaw || "").trim();
       const v = decodeURIComponent(vRaw || "").trim();
       if (!k) continue;
       out[k] = v;
     }
     return out;
   }
   function parseBreadcrumb(str) {
     const labels = (str || "")
       .split(",")
       .map(s => s.trim())
       .filter(Boolean);
     return labels.map(label => ({ label }));
   }
   function openFullscreen() {
     document.getElementById("launcher").style.display = "none";
     document.getElementById("host").style.display = "block";
     document.getElementById("close").style.display = "block";
     document.body.style.overflow = "hidden";
   }
   function closeFullscreen() {
     document.getElementById("host").style.display = "none";
     document.getElementById("launcher").style.display = "flex";
     document.getElementById("close").style.display = "none";
     document.getElementById("host").innerHTML = "";
   }
   document.getElementById("close").onclick = closeFullscreen;
   document.getElementById("launchBtn").onclick = () => {
     const communityUri = document.getElementById("communityUri").value.trim();
     const visualforce = document.getElementById("visualforce").value.trim() || "javascriptIntegration";
     const component = document.getElementById("componentName").value.trim();
     const paramsText = document.getElementById("paramsText").value;
     const breadcrumbStr = document.getElementById("breadcrumb").value;
     if (!component) {
       alert("Inserisci il nome del componente (es. mobilityLeadListView).");
       return;
     }
     if (!communityUri) {
       alert("Inserisci la Community base (es. https://.../tabs/).");
       return;
     }
     // fallback usato dal bundle
     localStorage.setItem("fallback", "true");
     // Application deve essere l’istanza reale del bundle (come hai testato prima)
     window.Application = new window.AxaApplication({}, (authParams) => console.log("[authCallback]", authParams));
     if (window.SalesforceAuth) window.SalesforceAuth.communityURI = communityUri;
     // prepara params per SalesforceConnect
     const paramsObj = parseQueryString(paramsText);
     paramsObj.auth = true;                // forza authenticated nel Lightning
     paramsObj.lwc = false;                // iframe mode
     paramsObj.visualforce = visualforce;  // VF page
     paramsObj.breadcrumb = parseBreadcrumb(breadcrumbStr);
     // Fullscreen
     openFullscreen();
     // Host container
     const host = document.getElementById("host");
     const containerId = component; // usa il nome componente come id (coerente col tuo Lightning)
     host.innerHTML = `<div id="${containerId}"></div>`;
     // Monta il componente: crea iframe con src costruito da generateUrl()
     new window.SalesforceConnect(
       component,
       containerId,
       paramsObj
     );
     // debug: stampa src iframe dopo mount
     setTimeout(() => {
       const iframe = document.getElementById(containerId);
       console.log("[iframe src]", iframe?.getAttribute("src"));
     }, 800);
   };
</script>
</body>
</html>
